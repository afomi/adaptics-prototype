<!DOCTYPE html>
<html>
<head>
	<title>
		Adaptics - non-geographical maps
	</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<style media="screen">
		html, body {
			height: 100%
		}

		.bottom-drawer {
			height: 75px;
		}
	</style>
</head>
<body>
<div id="mapid" style="width: 100%; height: calc(100% - 75px)"></div>
<script
  src="https://code.jquery.com/jquery-3.4.0.slim.js"
  integrity="sha256-milezx5lakrZu0OP9b2QWFy1ft/UEUK6NH1Jqz8hUhQ="
  crossorigin="anonymous"></script>
<script>
	var mymap = L.map('mapid').setView([51.505, -0.09], 13);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 3,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);


	// takes a L.LatLng
	// returns Bounds [L.LatLng, L.LatLng]
	//   with an offset based on visual pixels
	function dynamicBounds(latlng) {
		var originLatLng = latlng;
		var originPoint = mymap.project(originLatLng)
		var cardDimensionsAsPx = 30;
		var targetPoint = L.point(originPoint.x + cardDimensionsAsPx, originPoint.y + cardDimensionsAsPx);
		var targetLatLng = mymap.unproject(targetPoint, mymap.getZoom());
		var bounds = [originLatLng, targetLatLng];
		return bounds;
	}

	// Create an orange rectangle in the center of the map
	var xpoint = mymap.getCenter();
	var bounds = dynamicBounds(xpoint);
	var box1 = L.rectangle(bounds, {color: "#ff7800", weight: 1}).addTo(mymap);

	var popup = L.popup();
	function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent("You clicked the map at " + e.latlng.toString())
			.openOn(mymap);
	}

	mymap.on('click', onMapClick);
	mymap.on("click", function(e) {
		clickHandler(e);
	})

	function clickHandler(e) {
		var lat = e.latlng.lat;
		var lng = e.latlng.lng;
		var bounds = [[lat, lng], [lat+2, lng+2]];
		drawRectangle(bounds)
	}

	// Draw a line between this rectangle and Box1
	function drawLineToBox1(box) {
		// draw a polyline between the centers of box1 and box
			var latlngs = [
				box.getCenter(),
				box1.getCenter(),
			];
		var polyline = L.polyline(latlngs, {color: 'black'}).addTo(mymap);

		// NEEDS TO BE SPLIT OUT
		var myIcon = L.divIcon({className: 'my-div-icon', html: "STRRRRNG"});
		// you can set .my-div-icon styles in CSS
		L.marker(box.getCenter(), {icon: myIcon}).addTo(mymap);
	}

	function drawRectangle(bounds) {
		// create an orange rectangle
		var box = L.rectangle(bounds, {color: "#ff7800", weight: 1}).addTo(mymap);
		box.attributes = {};
		// free form
		box.attributes.freeFormX = (mymap.project(box.getCenter()).x); // not pixel X (map X)
		box.attributes.freeFormY = (mymap.project(box.getCenter()).y);
		// 2X2 attributes (x, y axes)
		box.attributes.effort =  Math.random() * 90;
		box.attributes.value = Math.random() * 90;
		// Aging (horizontally)
		box.attributes.daysOld = Math.random() * 365;
		// Sort by Story Size (vertically)
		box.attributes.storySize = Math.random() * 10;

		drawLineToBox1(box);
	}

	// Set the Space type...

	// TRIGGER 2X2
	// TRIGGER SIZE SORT
	// TRIGGER AGE SORT
	// TRIGGER FREE FORM

	function drawFreeForm() {
		// for each Rectangle
		// re-draw based on effort/value functional coordinates...
		mymap.eachLayer(function(layer) {
			if(!layer.attributes || (layer.attributes && !layer.attributes.freeFormX)) {
				return true
			}
			// use the X & Y coordinates from the FreeFrom `Space`
			var point = L.point(layer.attributes.freeFormX, layer.attributes.freeFormY)
			var lat = mymap.unproject(point, mymap.getZoom()).lat;
			var lng = mymap.unproject(point, mymap.getZoom()).lng;

			var xpoint = L.latLng(lat, lng);
			var bounds = dynamicBounds(xpoint);
			layer.setBounds(bounds);
		})
	}

	function draw2x2() {
		// for each Rectangle
		// re-draw based on effort/value functional coordinates...
		mymap.eachLayer(function(layer) {
			if(!layer.attributes) {
				return true
			}
			// EFFORT / VALUE
			// TRANSLATE to x/y coords
			// for x within 0-100
			// translate to where X falls with 0-screen-width - using D3 range
			var xAxis = d3.scaleLinear().domain([0, 100]).range([0, mapWidth]);
			var yAxis = d3.scaleLinear().domain([0, 100]).range([0, mapHeight]);
			var x = xAxis(layer.attributes.effort); // returns x pixel location
			var y = yAxis(layer.attributes.value); // returns x pixel location
			// var y = mymap.project(mymap.getCenter()).y; // returns y pixel of the map (height of midpoint)

			var point = mymap.unproject(L.point(x, y), mymap.getZoom());

			// console.log("ZZ", layer.attributes.effort, z);
			var bounds = dynamicBounds(point);
			layer.setBounds(bounds);
		})
	}

	function drawAgeSort() {
		var i = 0;
		// for each Rectangle
		// re-draw based on effort/value functional coordinates...
		mymap.eachLayer(function(layer) {
			if(!layer.attributes) {
				return true
			}
			var yAxis = d3.scaleLinear().domain([0, 100]).range([0, mapHeight]);
			// translate days old into vertical coordinates
			function translateCoords(days) { // accepts days 0 - 365
				return 365 / days;
			}
			var y = yAxis(layer.attributes.daysOld)
			var x = mymap.project(mymap.getCenter()).x;

			var point = mymap.unproject(L.point(x, y), mymap.getZoom());
			var bounds = dynamicBounds(point);
			layer.setBounds(bounds);
		})
	}

	function drawSizeSort() {
		// for each Rectangle
		// re-draw based on effort/value functional coordinates...
		var xAxis = d3.scaleLinear().domain([0, 365]).range([0, mapWidth]);

		mymap.eachLayer(function(layer) {
			if(!layer.attributes) {
				return true;
			}

			// Translate Age to range. Maybe D3?
			var xAxis = d3.scaleLinear().domain([0, 10]).range([0, mapHeight]);
			var storySize = layer.attributes.storySize;
			var x = xAxis(storySize);
			var y = mymap.project(mymap.getCenter()).y;

			var point = mymap.unproject(L.point(x, y), mymap.getZoom());
			var bounds = dynamicBounds(point);
			layer.setBounds(bounds);
		})
	}

	// DUMMY UP SOME OBJECTS FOR US
	// for(var i=0; i < 10; i++) {
	// 	var bounds = [[54.559322, -5.767822 + Math.random() * 5], [56.1210604, -3.021240 +  Math.random() * 5]];
	// 	drawRectangle(bounds);
	// }

	$(function() {
		$("#draw2x2").on("click", function() {
			draw2x2();
		});
		$("#drawAgeSort").on("click", function() {
			drawAgeSort();
		});
		$("#drawSizeSort").on("click", function() {
			drawSizeSort();
		});
		$("#drawFreeForm").on("click", function() {
			drawFreeForm();
		});

		mapWidth = $("#mapid").width();
		mapHeight = $("#mapid").height();
	});

	// Globals
	var mapWidth;
	var mapHeight;
</script>

	<div class="bottom-drawer">
		<a href="#" id="drawFreeForm">Free Form</a> &middot;
		<a href="#" id="draw2x2">Draw 2X2</a> &middot;
		<a href="#" id="drawSizeSort">Sort by Size</a> &middot;
		<a href="#" id="drawAgeSort">Sort by Age</a>
	</div>
</body>
</html>
